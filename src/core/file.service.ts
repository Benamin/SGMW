import {File} from "@ionic-native/file";import {FileOpener} from "@ionic-native/file-opener";import {Injectable} from "@angular/core";import {AlertController, LoadingController, Platform} from "ionic-angular";import {CommonService} from "./common.service";import {Storage} from "@ionic/storage";import {FileTransfer, FileTransferObject} from "@ionic-native/file-transfer";import {DocumentViewer} from '@ionic-native/document-viewer';import {AndroidPermissions} from '@ionic-native/android-permissions';@Injectable()export class FileService {    constructor(private file: File, public fileOpener: FileOpener,                private loadingCtrl: LoadingController,                private commonSer: CommonService,                public platform: Platform,                public androidPermission: AndroidPermissions,                public alertCtrl: AlertController,                public transfer: FileTransfer,                public document: DocumentViewer,                private storage: Storage    ) {    }    /**     * 安卓手机下载文档     * @param fileUrl  文件地址     * @param fileName  文件名称     */    downloadFile(fileUrl, fileName) {        if (this.platform.is('ios')) {  //ios文件不能下载只能预览            this.ViewFile(fileUrl, fileName);            return;        }        this.androidPermission.checkPermission(this.androidPermission.PERMISSION.WRITE_EXTERNAL_STORAGE).then(            (result) => {                console.log('本机权限状态:' + result.hasPermission);                if (result.hasPermission) {                    this.downloadForAndroid(fileUrl, fileName);                } else {                    this.androidPermission.requestPermission(this.androidPermission.PERMISSION.WRITE_EXTERNAL_STORAGE).then(                        (res) => {                            if (res.hasPermission) {                                this.downloadForAndroid(fileUrl, fileName);                            } else {                                this.commonSer.toast('无手机存储权限');                            }                        }                    )                }            }, (err) => {                console.log('requestPermission');                //申请手机权限            });    }    downloadForAndroid(fileUrl, fileName) {        let storageDirectory = null;        if (this.platform.is('android')) {            this.file.createDir(this.file.externalRootDirectory, 'sgmw', true).then((result) => {            });            storageDirectory = this.file.externalRootDirectory + 'sgmw/';        } else {            storageDirectory = this.file.cacheDirectory;        }        const uploadLoading = this.loadingCtrl.create({            content: '下载中...',            dismissOnPageChange: true,            enableBackdropDismiss: true,        });        uploadLoading.present();        const fileTransfer: FileTransferObject = this.transfer.create();        const fileType = this.getFileMimeType(fileName);        const downloadURL = encodeURI(fileUrl.split('?')[0]) + "?" + fileUrl.split('?')[1];        fileTransfer.download(downloadURL, storageDirectory + fileName).then((entry) => {            let blob = entry.toURL();            uploadLoading.dismiss();            this.commonSer.toast('下载课件成功');        }, (error) => {            uploadLoading.dismiss();            this.commonSer.alert(`下载出错，请重新下载,${JSON.stringify(error)}`);        });        fileTransfer.onProgress((event) => {            let progress = Math.round(100.0 * event.loaded / event.total);            uploadLoading.setContent('下载中...' + progress + '%');        });    }    /**     * 预览文件 包括安卓手机和ios手机     * @param fileUrl     * @param fileName     * @constructor     */    ViewFile(fileUrl, fileName) {        const uploadLoading = this.loadingCtrl.create({            content: '加载中...',            dismissOnPageChange: true,            enableBackdropDismiss: true,        });        uploadLoading.present();        let path = this.file.dataDirectory;        const fileTransfer: FileTransferObject = this.transfer.create();        const fileType = this.getFileMimeType(fileName);        const downloadURL = encodeURI(fileUrl.split('?')[0]) + "?" + fileUrl.split('?')[1];        fileTransfer.download(downloadURL, path + fileName).then((entry) => {            let url = entry.toURL();            uploadLoading.dismiss();            this.fileOpener.open(url, fileType).then(res => {            }, error => {                this.commonSer.alert(`打开文件出错,${JSON.stringify(error)}`);            });        },(error) => {            uploadLoading.dismiss();            this.commonSer.alert(`下载出错，请重新下载,${JSON.stringify(error)}`);        });        fileTransfer.onProgress((event) => {            let progress = Math.round(100.0 * event.loaded / event.total);            uploadLoading.setContent('加载中...' + progress + '%');        });    }    //获取文件类型    getFileMimeType(fileName: string): string {        let fileType = fileName.substring(fileName.lastIndexOf('.') + 1, fileName.length).toLowerCase();        let mimeType: string = '';        switch (fileType) {            case 'txt':                mimeType = 'text/plain';                break;            case 'docx':                mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';                break;            case 'doc':                mimeType = 'application/msword';                break;            case 'pptx':                mimeType = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';                break;            case 'ppt':                mimeType = 'application/vnd.ms-powerpoint';                break;            case 'xlsx':                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';                break;            case 'xls':                mimeType = 'application/vnd.ms-excel';                break;            case 'zip':                mimeType = 'application/x-zip-compressed';                break;            case 'rar':                mimeType = 'application/octet-stream';                break;            case 'pdf':                mimeType = 'application/pdf';                break;            case 'jpg':                mimeType = 'image/jpeg';                break;            case 'png':                mimeType = 'image/png';                break;            default:                mimeType = 'application/' + fileType;                break;        }        return mimeType;    }}